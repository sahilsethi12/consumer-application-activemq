<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="        http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd        http://camel.apache.org/schema/spring       https://camel.apache.org/schema/spring/camel-spring.xsd">
    <camelContext id="camel" xmlns="http://camel.apache.org/schema/spring" errorHandlerRef="myErrorHandler">


        <errorHandler id="myErrorHandler" type="DeadLetterChannel"
                      deadLetterUri="amqps:customdlq?connectionFactory=#jmsConnectionFactory">
            <redeliveryPolicy maximumRedeliveries="3" redeliveryDelay="5000"/>
        </errorHandler>



        <route id="dlqTestConsumer">
            <from uri="amqps:incomingOrders?connectionFactory=#jmsConnectionFactory"/>
            <convertBodyTo type="java.lang.String"/>
            <log message="Received message from amqps:incomingOrders ${body}"/>
            <setHeader name="sanity_status">
                <jsonpath>$.status</jsonpath>
            </setHeader>

            <choice>
                <when>
                    <simple>${header.status} == 'failed' || ${header.status} == 'FAILED'</simple>
                    <log message="Ready to throw exception"/>
                    <process ref="failureProcessor"/>
                </when>
                <otherwise>
                    <setHeader name="Content-Type">
                        <simple>application/json</simple>
                    </setHeader>
                    <setBody>
                        <simple>{"message":"Successfully Received", "date":"${date:now:yyyy-MM-dd HH:mm:ss}"}</simple>
                    </setBody>
                </otherwise>
            </choice>

        </route>


        <route id="dlqConsumer" autoStartup="false">
                <from uri="amqps:customdlq?connectionFactory=#jmsConnectionFactory"/>
            <log message="ðŸ“¥ Message moved to DLQ: ${body}"/>
        </route>

    </camelContext>
    <bean
            class="org.apache.camel.component.servlet.CamelHttpTransportServlet" id="camelHttpTransportServlet"/>
    <bean
            class="org.springframework.boot.web.servlet.ServletRegistrationBean" id="servlet">
        <property name="name" value="CamelServlet"/>
        <property name="servlet" ref="camelHttpTransportServlet"/>
        <property name="urlMappings" value="/api/*"/>
    </bean>



    <bean id="failureProcessor" class="com.example.demo.FailureProcessor"/>

    <!-- Qpid JMS ConnectionFactory -->
    <bean id="jmsConnectionFactory"
          class="org.apache.qpid.jms.JmsConnectionFactory">
        <property name="remoteURI" value="${amqp.url}"/>
        <property name="username" value="${amqp.username}"/>
        <property name="password" value="${amqp.password}"/>
    </bean>

    <!-- Bind AMQP component to Camel -->
    <bean id="amqps" class="org.apache.camel.component.amqp.AMQPComponent">
        <property name="connectionFactory" ref="jmsConnectionFactory"/>
        <property name="acknowledgementModeName" value="CLIENT_ACKNOWLEDGE"/>

    </bean>

</beans>
